<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Producers and Consumers - pymsgbus</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Producers and Consumers";
        var mkdocs_page_input_path = "consumers.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> pymsgbus
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../types/">Definitions</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../pubsub/">Publisher and Subscribers</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="#">Producers and Consumers</a>
    <ul class="current">
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../events/">Events</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../services/">Services</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../sessions/">Unit Of Work</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">pymsgbus</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Producers and Consumers</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h3 id="get-consumers-notified-with-the-producerconsumer-pattern">Get consumers notified with the Producer/Consumer pattern.</h3>


<div class="doc doc-object doc-module">



<a id="pymsgbus.consumers"></a>
    <div class="doc doc-contents first">








  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="pymsgbus.consumers.Consumer" class="doc doc-heading">
            <code>Consumer</code>


</h2>


    <div class="doc doc-contents ">


        <p>A CONSUMER is a component that listens for and reacts to events or certain types of messages 
within a BOUNDED CONTEXT. Consumers are responsible for processing events and triggering side
effects in response to them.</p>
<p>Unlike a SUBSCRIBER, a consumer is responsible for deciding which handlers to invoke based on
the message type.</p>


<p><span class="doc-section-title">Methods:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="pymsgbus.consumers.Consumer.register" href="#pymsgbus.consumers.Consumer.register">register</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Registers a message type and its corresponding handler function.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="pymsgbus.consumers.Consumer.handler" href="#pymsgbus.consumers.Consumer.handler">handler</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Decorator for registering a handler function for one or more message types.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="pymsgbus.consumers.Consumer.handle" href="#pymsgbus.consumers.Consumer.handle">handle</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Consumes a message by invoking its registered handler functions.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="pymsgbus.consumers.Consumer.consume" href="#pymsgbus.consumers.Consumer.consume">consume</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Consumes an occurrence of the given event type with the given payload. This method validates the payload
and invokes the corresponding handler functions.</p>
                </div>
              </td>
            </tr>
            <tr class="doc-section-item">
              <td><code><a class="autorefs autorefs-internal" title="pymsgbus.consumers.Consumer.listen" href="#pymsgbus.consumers.Consumer.listen">listen</a></code></td>
              <td>
                <div class="doc-md-description">
                  <p>Register this consumer to a given producer. An event producer could be any class
that implements the <code>Producer</code> protocol with a <code>register</code> method.</p>
                </div>
              </td>
            </tr>
      </tbody>
    </table>
        <p>Example:</p>
<pre><code>.. code-block:: python

@dataclass
class UserCreated:
    id: str
    name: str

@dataclass
class UserUpdated:
    id: str
    name: str

consumer = Consumer()

db = {} # Database
nfs = [] # Notification flags

@consumer.handler
def on_user_created(event: UserCreated | UserUpdated):
    db[event.id] = event
    nfs.append(event)

producer = Producer()
producer.register(consumer)
producer.publish(UserCreated(id='1', name='Alice'))
producer.publish(UserUpdated(id='1', name='Bob'))
assert db['1'].name == 'Bob'
assert nfs[0].name == 'Alice'
assert nfs[1].name == 'Bob'
</code></pre>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="pymsgbus.consumers.Consumer.__init__" class="doc doc-heading">
            <code class="highlight language-python">__init__(name=None, cast=True, provider=None, generator=lambda name: name, validator=lambda type, payload: type(**payload))</code>

</h3>


    <div class="doc doc-contents ">

        <p>Initializes a new instance of the Subscriber class.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>name</code></b>
                  (<code>str</code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>The name of the subscriber. Defaults to None.</p>
              </div>
            </li>
            <li>
              <b><code>cast</code></b>
                  (<code>bool</code>, default:
                      <code>True</code>
)
              –
              <div class="doc-md-description">
                <p>Casting dependencies during dependency injection. Defaults to True.</p>
              </div>
            </li>
            <li>
              <b><code>provider</code></b>
                  (<code><span title="pymsgbus.depends.Provider">Provider</span></code>, default:
                      <code>None</code>
)
              –
              <div class="doc-md-description">
                <p>. The dependency provider for dependency injection. Defaults to None.</p>
              </div>
            </li>
            <li>
              <b><code>generator</code></b>
                  (<code><span title="typing.Callable">Callable</span>[[str], str]</code>, default:
                      <code>lambda name: <span title="pymsgbus.consumers.Consumer.name">name</span></code>
)
              –
              <div class="doc-md-description">
                <p>The generator function for generating the handler key. Defaults to lambda name: name.</p>
              </div>
            </li>
            <li>
              <b><code>validator</code></b>
                  (<code><span title="typing.Callable">Callable</span>[[<span title="typing.Any">Any</span>, <span title="typing.Any">Any</span>], <span title="typing.Any">Any</span>]</code>, default:
                      <code>lambda type, payload: type(**payload)</code>
)
              –
              <div class="doc-md-description">
                <p>The validator function for validating the payload. Defaults to lambda type, payload: type(**payload).</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="pymsgbus.consumers.Consumer.consume" class="doc doc-heading">
            <code class="highlight language-python">consume(event_type, payload)</code>

</h3>


    <div class="doc doc-contents ">

        <p>Consumes an occurrence of the given event type with the given payload.
This method validates the payload and invokes the corresponding handler functions.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>occurrence</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>The event type to consume.</p>
              </div>
            </li>
            <li>
              <b><code>payload</code></b>
                  (<code><span title="typing.Any">Any</span></code>)
              –
              <div class="doc-md-description">
                <p>The event payload to consume.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="pymsgbus.consumers.Consumer.handle" class="doc doc-heading">
            <code class="highlight language-python">handle(event)</code>

</h3>


    <div class="doc doc-contents ">

        <p>Handles an event by invoking its registered handler functions.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>event</code></b>
                  (<code>Event</code>)
              –
              <div class="doc-md-description">
                <p>The event to handle.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="pymsgbus.consumers.Consumer.handler" class="doc doc-heading">
            <code class="highlight language-python">handler(wrapped)</code>

</h3>


    <div class="doc doc-contents ">

        <p>Decorator for registering a handler function for one or more event types.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>wrapped</code></b>
                  (<code><span title="typing.Callable">Callable</span>[..., None]</code>)
              –
              <div class="doc-md-description">
                <p>The handler function to register.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
<b><code>Callable</code></b>(                  <code><span title="typing.Callable">Callable</span>[..., None]</code>
)              –
              <div class="doc-md-description">
                <p>The original handler function, unmodified.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<details class="note" open>
  <summary>Note</summary>
  <p>If the handler function is annotated with a union of event types,
all of those types will be registered for the given handler.</p>
</details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="pymsgbus.consumers.Consumer.listen" class="doc doc-heading">
            <code class="highlight language-python">listen(producer)</code>

</h3>


    <div class="doc doc-contents ">

        <p>Registers this consumer with a given producer. An event producer could be an <code>Events</code> instance or
any class that implements the <code>Producer</code> protocol with a <code>register</code> method.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>producer</code></b>
                  (<code><a class="autorefs autorefs-internal" title="pymsgbus.consumers.Producer" href="#pymsgbus.consumers.Producer">Producer</a></code>)
              –
              <div class="doc-md-description">
                <p>The producer to register this consumer with.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="pymsgbus.consumers.Consumer.on" class="doc doc-heading">
            <code class="highlight language-python">on(exception_type)</code>

</h3>


    <div class="doc doc-contents ">

        <p>Decorator for registering a handler for a given exception type. The handler is called when an exception of
the given type is raised.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>exception_type</code></b>
                  (<code>type[Exception]</code>)
              –
              <div class="doc-md-description">
                <p>The type of the exception to be handled.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <p>The handler function.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="pymsgbus.consumers.Consumer.register" class="doc doc-heading">
            <code class="highlight language-python">register(annotation, handler)</code>

</h3>


    <div class="doc doc-contents ">

        <p>Register a handler for a given annotation. This method is called recursively to handle nested annotations.
Don't call this method directly, use the handler decorator instead. This method is called by the handler decorator.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>annotation</code></b>
                  (<code><span title="typing.Any">Any</span></code>)
              –
              <div class="doc-md-description">
                <p>The annotation to register.</p>
              </div>
            </li>
            <li>
              <b><code>handler</code></b>
                  (<code><span title="typing.Callable">Callable</span></code>)
              –
              <div class="doc-md-description">
                <p>The handler function for the event.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="pymsgbus.consumers.Consumer.validate" class="doc doc-heading">
            <code class="highlight language-python">validate(type, payload)</code>

</h3>


    <div class="doc doc-contents ">

        <p>Validate the payload associated with the given type. The type is used to determine the validator function to be used.
The validator function defaults to the constructor of the type class. If you are using a validation library like pydantic,
you can override the validator function to use the pydantic model_validate function.</p>


<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Parameters:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              <b><code>type</code></b>
                  (<code>str</code>)
              –
              <div class="doc-md-description">
                <p>The type of the payload to be validated.</p>
              </div>
            </li>
            <li>
              <b><code>payload</code></b>
                  (<code><span title="typing.Any">Any</span></code>)
              –
              <div class="doc-md-description">
                <p>The payload to be validated.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Raises:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
                  <code><span title="pymsgbus.exceptions.TypeNotFound">TypeNotFound</span></code>
              –
              <div class="doc-md-description">
                <p>If the type is not registered.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>

<table class="field-list">
  <colgroup>
    <col class="field-name" />
    <col class="field-body" />
  </colgroup>
  <tbody valign="top">
    <tr class="field">
      <th class="field-name">Returns:</th>
      <td class="field-body">
        <ul class="first simple">
            <li>
              –
              <div class="doc-md-description">
                <p>The validated payload as an instance of the type class.</p>
              </div>
            </li>
        </ul>
      </td>
    </tr>
  </tbody>
</table>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="pymsgbus.consumers.Producer" class="doc doc-heading">
            <code>Producer</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="typing.Protocol">Protocol</span></code></p>


        <p>A PRODUCER is any component that produces messages within a BOUNDED CONTEXT. A producer is responsible for
emitting EVENTS that are consumed by consumers. You can implement a producer implementing the <code>register</code>
method to register consumers, and some delivery mechanism to deliver the events to them.</p>
<p>Example:</p>
<pre><code>.. code-block:: python

from pymsgbus import Consumer

class Repository:
    def __init__(self, id: str, name: str):
        self.id = id
        self.name = name
        self.consumers = Consumers()

    def register(self, consumer: Consumer):
        self.consumers.append(consumer)

    def save(self, aggregate: Aggregate):
        for consumer in self.consumers:
            consumer.consume('AggregateSaved', aggregate)
</code></pre>









  <div class="doc doc-children">











  </div>

    </div>

</div>




  </div>

    </div>

</div>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../pubsub/" class="btn btn-neutral float-left" title="Publisher and Subscribers"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../events/" class="btn btn-neutral float-right" title="Events">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../pubsub/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../events/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
